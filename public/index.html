<!DOCTYPE html>
<html lang="es" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Marketing Control Center</title>
    <style>
        /* --- VARIABLES DE TEMA --- */
        :root {
            --bg-color: #f8fafc;
            --text-main: #1e293b;
            --text-muted: #64748b;
            --card-bg: rgba(255, 255, 255, 0.65);
            --card-border: rgba(255, 255, 255, 0.8);
            --input-bg: rgba(255, 255, 255, 0.8);
            --input-border: transparent;
            --primary: #6366f1;
            --primary-text: #ffffff;
            --blob-1: #c7d2fe;
            --blob-2: #fbcfe8;
            --term-bg: #1e1e1e;
            --term-text: #a9ff68;
            --term-border: rgba(0,0,0,0.1);
        }

        [data-theme="dark"] {
            --bg-color: #0f172a;
            --text-main: #f1f5f9;
            --text-muted: #94a3b8;
            --card-bg: rgba(30, 41, 59, 0.60);
            --card-border: rgba(255, 255, 255, 0.1);
            --input-bg: rgba(15, 23, 42, 0.6);
            --input-border: rgba(255, 255, 255, 0.1);
            --primary: #818cf8;
            --primary-text: #0f172a;
            --blob-1: #4338ca;
            --blob-2: #be185d;
            --term-bg: #000000;
            --term-text: #00ff00;
            --term-border: rgba(255,255,255,0.2);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            overflow: hidden;
            transition: background-color 0.5s ease;
            position: relative;
        }

        .background-blobs {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: -1;
            overflow: hidden;
        }

        .blob {
            position: absolute;
            border-radius: 50%;
            filter: blur(80px);
            opacity: 0.6;
            animation: float 10s infinite ease-in-out alternate;
        }
        .blob-1 { width: 400px; height: 400px; background: var(--blob-1); top: -100px; left: -100px; }
        .blob-2 { width: 300px; height: 300px; background: var(--blob-2); bottom: -50px; right: -50px; animation-delay: -5s; }
        @keyframes float { 0% { transform: translate(0, 0); } 100% { transform: translate(30px, 50px); } }

        .card {
            width: 100%; max-width: 420px; padding: 35px;
            border-radius: 32px; background: var(--card-bg);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--card-border);
            color: var(--text-main); position: relative;
            max-height: 90vh; overflow-y: auto;
        }

        .header-row { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 25px; }
        h1 { margin: 0; font-size: 1.4rem; font-weight: 700; }
        .subtitle { margin: 5px 0 0; font-size: 0.85rem; color: var(--text-muted); }
        .theme-toggle { background: var(--input-bg); border: 1px solid var(--card-border); color: var(--text-main); width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        
        .control-group { margin-bottom: 15px; }
        label { display: block; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; color: var(--text-muted); margin-bottom: 8px; }
        .row { display: flex; gap: 15px; }
        input, select { width: 100%; padding: 12px; border-radius: 12px; background: var(--input-bg); border: 1px solid var(--input-border); color: var(--text-main); outline: none; box-sizing: border-box; }

        .btn { width: 100%; padding: 14px; border-radius: 14px; font-weight: 600; cursor: pointer; border: none; margin-bottom: 10px; display: flex; justify-content: center; align-items: center; gap: 10px; }
        .btn-primary { background: var(--primary); color: var(--primary-text); }
        .btn-secondary { background: var(--input-bg); color: var(--text-main); border: 1px solid var(--card-border); }
        
        /* CONSOLA */
        .console-container { margin-top: 20px; background: var(--term-bg); border-radius: 12px; padding: 15px; border: 1px solid var(--term-border); font-family: monospace; font-size: 0.8rem; color: var(--term-text); height: 150px; overflow-y: auto; display: flex; flex-direction: column; }
        .log-entry { margin-bottom: 4px; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .log-entry.error { color: #ff5555; }
        .log-entry.success { color: #50fa7b; font-weight: bold; }
        .spinner { width: 18px; height: 18px; border: 2px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: currentColor; animation: spin 0.8s linear infinite; display: none; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="background-blobs"><div class="blob blob-1"></div><div class="blob blob-2"></div></div>
    <div class="card">
        <div class="header-row">
            <div><h1>Panel de Reportes</h1><p class="subtitle">Monitor de Procesos</p></div>
            <button class="theme-toggle" onclick="toggleTheme()">üåó</button>
        </div>

        <div class="control-group">
            <div class="row">
                <div style="flex: 2;">
                    <label>Mes</label>
                    <select id="month">
                        <option value="1">Enero</option><option value="2">Febrero</option><option value="3">Marzo</option>
                        <option value="4">Abril</option><option value="5">Mayo</option><option value="6">Junio</option>
                        <option value="7">Julio</option><option value="8">Agosto</option><option value="9">Septiembre</option>
                        <option value="10">Octubre</option><option value="11">Noviembre</option><option value="12">Diciembre</option>
                    </select>
                </div>
                <div style="flex: 1;">
                    <label>A√±o</label>
                    <input type="number" id="year">
                </div>
            </div>
        </div>

        <div class="control-group">
            <label>Enviar copia a (Email)</label>
            <input type="email" id="email" placeholder="Opcional: correo@ejemplo.com">
        </div>

        <button class="btn btn-primary" onclick="downloadPDF()">
            <span class="spinner" id="spin-download"></span><span id="txt-download">Descargar Reporte</span>
        </button>

        <button class="btn btn-secondary" onclick="sendEmail()">
            <span class="spinner" id="spin-email"></span><span id="txt-email">Enviar por Email</span>
        </button>

        <div class="console-container" id="console-box">
            <div class="log-entry">System: Esperando comandos...</div>
        </div>
    </div>

    <script>
        const API_URL = '';
        const today = new Date();
        document.getElementById('month').value = today.getMonth() + 1;
        document.getElementById('year').value = today.getFullYear();

        // --- CONEXI√ìN SSE ---
        let eventSource = null;
        function connectToLogs() {
            if (eventSource) return;
            eventSource = new EventSource(`${API_URL}/reports/events`);
            eventSource.onmessage = (event) => {
                const data = JSON.parse(event.data);
                addLog(data.message);
            };
        }
        
        function addLog(msg) {
            const box = document.getElementById('console-box');
            const div = document.createElement('div');
            div.className = 'log-entry';
            if(msg.includes('Error')) div.className += ' error';
            if(msg.includes('‚úÖ') || msg.includes('Completo')) div.className += ' success';
            div.textContent = `> ${msg}`;
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
        }

        // --- DESCARGAR ---
        async function downloadPDF() {
            const m = document.getElementById('month').value;
            const y = document.getElementById('year').value;
            toggleLoading('download', true);
            clearLog(); addLog(`üöÄ Iniciando descarga PDF (${m}/${y})...`);
            connectToLogs();

            try {
                const res = await fetch(`${API_URL}/reports/download?month=${m}&year=${y}`);
                if (!res.ok) throw new Error('Error en descarga');
                const blob = await res.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url; a.download = `Reporte_${m}_${y}.pdf`;
                document.body.appendChild(a); a.click(); a.remove();
                addLog('‚úÖ PDF Guardado en tu equipo.');
            } catch (e) { addLog('‚ùå Error: ' + e.message); }
            finally { toggleLoading('download', false); }
        }

        // --- ENVIAR EMAIL ---
        async function sendEmail() {
            const m = document.getElementById('month').value;
            const y = document.getElementById('year').value;
            const email = document.getElementById('email').value;
            toggleLoading('email', true);
            clearLog(); addLog(`üìß Preparando env√≠o a ${email || 'Admin'}...`);
            connectToLogs();

            try {
                const res = await fetch(`${API_URL}/reports/send-email?month=${m}&year=${y}&email=${email}`);
                const data = await res.json();
                if (data.success) addLog(`‚úÖ Email enviado exitosamente.`);
                else throw new Error(data.message);
            } catch (e) { addLog('‚ùå Error env√≠o: ' + e.message); }
            finally { toggleLoading('email', false); }
        }

        function toggleLoading(type, isLoading) {
            const btn = type === 'download' ? document.querySelector('.btn-primary') : document.querySelector('.btn-secondary');
            const txt = document.getElementById(`txt-${type}`);
            const spin = document.getElementById(`spin-${type}`);
            if (isLoading) { btn.style.opacity = 0.7; txt.style.display = 'none'; spin.style.display = 'block'; }
            else { btn.style.opacity = 1; txt.style.display = 'block'; spin.style.display = 'none'; }
        }
        function clearLog() { document.getElementById('console-box').innerHTML = ''; }
        function toggleTheme() {
            const html = document.documentElement;
            html.setAttribute('data-theme', html.getAttribute('data-theme') === 'dark' ? 'light' : 'dark');
        }
        connectToLogs();
    </script>
</body>
</html>